
## FASTER R-CNN ARCHITECTURE
![](https://i.imgur.com/bTArMEY.png)

1. **Region Proposal Network (RPN, 지역 제안 네트워크):** 이미지 내에서 객체가 있을 것으로 예상되는 영역을 제안하는 네트워크, 이 네트워크는 후보 영역(proposal)을 생성하여 객체가 있을만한 위치를 추정한다.
    
2. **Region of Interest (RoI) Pooling:** RPN이 제안한 후보 영역을 추출하고, 이 영역을 동일한 크기로 조정하여 후속 신경망에 입력할 수 있도록 준비한다.
    
3. **백본 신경망(Backbone Network):** 이미지를 입력으로 받아 특성을 추출하는 역할을 한다. 주로 컨볼루션 신경망(CNN) 구조를 사용한다.
    
4. **분류기(Classifier) 및 회귀기(Regressor):** RoI로부터 추출된 특성을 사용하여 객체의 클래스를 분류하고, 객체의 위치를 회귀한다.



## Anchor Box
* 객체 검출 모델에서 사용되는 사전 정의된 박스
* 이 박스들은 이미지 내에서 객체의 위치와 크기를 추정하기 위해 활용
* 이미지 내의 1개의 픽셀을 기준으로, 총 9개의 영역에 서로 다른 크기(128, 256, 512), 서로 다른 비율(1:1, 1:2, 2:1)의 Anchor box를 사용하여 객체의 위치와 크기를 추정
* Anchor Box는 원본 이미지에 사용하는것이 아닌, feature map의 모든 픽셀에 사용
![](https://i.imgur.com/2FGFd1w.png)
![](https://i.imgur.com/cfU86qw.png)



원본 이미지가 1/16 크기의 Feature Map으로 Down Sampling될때, 아래 사진의 빨간 점들이 9개의 Anchor Box의 중심으로 사용된다.
![](https://i.imgur.com/CcY6bJT.png)

### Anchor Box의 단점
1. **크기와 비율 선택의 어려움:** Anchor box의 크기와 비율을 어떻게 선택할지에 대한 최적의 방법이 명확하지 않다. 데이터셋이나 작업에 따라 최적의 Anchor box 크기와 종횡비가 다를 수 있기 때문에 이를 결정하는 것이 어려울 수 있다.
    
2. **객체의 다양성 대응 어려움:** Anchor box는 여러 크기와 비율을 가지고 있지만, 특정한 모양이나 크기를 가진 객체에 대한 적응성이 제한될 수 있다. 

3. **불필요한 박스 생성:** Anchor box는 이미지의 여러 위치에 대해 박스를 생성하므로, 이로 인해 많은 후보 영역(proposal)이 만들어질 수 있다. 
    
4. **고정된 박스 개수:** Anchor box는 미리 정의된 개수의 박스를 사용하므로, 객체의 크기나 비율을 완벽하게 대응시키기 어려울 수 있다.



### RPN network
객체 검출 모델의 한 부분으로, 주로 Faster R-CNN과 같은 모델에서 사용된다. RPN은 후보 객체 영역(proposal)을 생성하는 네트워크로, 객체가 있을 것으로 예상되는 위치를 제안한다.
* RPN의 주요 목적은 이미지 내의 여러 위치에서 객체의 존재 여부를 예측하고 후보 객체 영역을 제안하는 것
* RPN은 기본적으로 CNN(Convolutional Neural Network) 아키텍처를 기반으로 하며, 주로 기존의 백본 신경망(backbone network)과 함께 사용
![](https://i.imgur.com/gmbBDZW.png)

RPN의 주요한 작업
1. **Anchor 생성:** RPN은 이미지를 입력으로 받아 여러 크기와 종횡비를 가진 Anchor box들을 생성한다. 이 Anchor box들은 객체가 있을 것으로 예상되는 위치를 대표하는 후보 영역들로 사용된다.
    
2. **객체/배경 예측:** 각 Anchor box에 대해 RPN은 객체가 있을 확률과 배경일 확률을 예측한다. 이는 이진 분류 작업으로, 객체가 있는지 여부를 판단하고 해당 객체의 위치를 추론하는 데 사용된다.

Anchor Box의 각각 크기가 다르지만 1x1의 convolution을 사용하는 것은 Anchor box의 위치와 객체/배경 여부를 예측하는 과정에서 발생하는 연산적인 효율성 때문이다.


### RPN Bounding Box Regression
Anchor box의 위치를 조정하여 정확한 객체의 위치를 예측하는 과정
![](https://i.imgur.com/XJSEgtR.png)
일반적으로 객체 검출 모델에서 Anchor box는 객체의 위치를 예측하고자 하는 일련의 후보 영역을 생성한다. 이러한 후보 영역들은 초기에는 정확한 객체의 위치와 일치하지 않을 가능성이 높다. 따라서 Anchor box의 위치를 조정하여 실제 객체의 위치와 더 정확하게 일치하도록 수정해야 해야하는데, 이 과정을 RPN Bounding Box Regression이라고 한다.


1. **훈련 과정에서의 역전파:** 객체가 있을 것으로 예상되는 Anchor box들에 대해 실제 객체의 위치와의 차이를 계산한다. 이 차이는 보통 좌표 값의 변화(예를 들어, 중심점의 이동, 폭과 높이의 변화 등)를 의미한다.
    
2. **손실 함수 최적화:** 예측된 위치와 실제 객체의 위치 간의 차이를 최소화하기 위해 손실 함수를 정의하고, 이를 최적화하는 과정에서 신경망을 훈련한다.
    
3. **예측된 위치 조정:** 학습된 모델을 통해 새로운 이미지에 대해 객체의 위치를 예측할 때, Anchor box의 초기 위치를 예측하고 이후 Bounding Box Regression을 사용하여 위치를 조정한다. 이를 통해 보다 정확한 객체의 위치를 추정한다.

예측된 위치와 가장 가까운 Anchor Box를 찾고, 해당 Anchor Box와 실제 객체의 위치와의 차이를 계산하여 예측된 위치를 조정하는것


### Positive Anchor Box, Negative Anchor Box
* 객체 감지(Object Detection) 작업에서 모델을 효과적으로 훈련시키고 일반화시키기 위한 중요한 요소
![](https://i.imgur.com/1Q9xSr7.png)
IoU가 0.7이상이면, 앵커 박스와 실제 상자 간의 겹침이 70% 이상인 경우를 객체로 간주하고 이것을 Positive Anchor Box로 분류한다.

Positive Anchor Box, Negative Anchor Box의 사용 이유
1. **정보 제공 및 학습 효율성**
    - 양성 앵커 박스는 실제 객체의 위치와 크기에 대응한다. 이를 통해 모델은 실제 객체에 대한 정보를 학습하고 객체의 특징을 추출할 수 있다.
    - 음성 앵커 박스는 배경이나 객체가 없는 지역에 해당한다. 이를 통해 모델은 배경에 대한 정보를 학습하고 배경과 객체를 구별하는 능력을 향상시킬 수 있다.

2. **클래스 불균형 극복**
    - 대부분의 이미지에서는 객체가 차지하는 영역보다 배경이 훨씬 많은데, 이로 인해 클래스 간의 불균형이 발생한다. 양성 및 음성 앵커 박스를 사용하여 학습 데이터에서 클래스 간의 균형을 유지할 수 있다.

3. **모델 안정성 및 일반화 향상**
    - 양성 앵커 박스를 사용하여 모델은 객체의 위치 및 특징을 학습하고, 음성 앵커 박스를 사용하여 배경을 학습한다. 이는 모델이 특정 객체를 정확하게 감지하면서도 일반적인 환경에서 잘 작동하도록 도와준다.
    - 클래스 간의 균형을 유지하고 배경을 학습함으로써 모델의 안정성을 향상시키고, 다양한 환경에서 일반화 성능을 향상시킬 수 있다.


### RPN(Region Proposal Network) Loss 함수
* 정답에 가까운 Anchor Box를 빨리 찾기위해 
![](https://i.imgur.com/UwQVLB3.png)
RPN의 손실 함수는 주로 두 가지 목표를 달성하기 위해 설계되었다.

1. **앵커 박스의 위치를 정확하게 조정하기** 
	* RPN은 이미지 내의 여러 위치에 대해 앵커 박스를 생성하고, 각 앵커 박스의 위치를 정확하게 조정하여 실제 객체에 더 잘 맞추도록 학습한다.
    
2. **정답에 가까운 앵커 박스를 빨리 찾기** 
	RPN은 객체가 있는 위치에 대한 정확한 앵커 박스를 빠르게 찾아내기 위해 훈련된다. 이것은 높은 IoU (Intersection over Union)를 가진 앵커 박스를 양성으로 선택하여 학습하는 과정을 통해 이루어진다. IoU는 앵커 박스와 실제 객체의 경계 상자 간의 겹치는 정도를 나타낸다.
    

RPN의 손실 함수에는 일반적으로 위치 회귀 손실(Regression Loss) 및 앵커 분류 손실(Classification Loss)이 포함된다. 위치 회귀 손실은 앵커 박스의 위치를 정확하게 조정하는 데 기여하며, 앵커 분류 손실은 양성 및 음성 앵커 박스를 구별하여 정답에 가까운 앵커 박스를 찾는 데 기여한다.